# -*- mode: sh; -*-
source ~/.color


## GIT
SCM_THEME_PROMPT_DIRTY="✗"
SCM_THEME_PROMPT_CLEAN="✓"

repo_branch() {
    git branch 2> /dev/null | sed -e '/^[^*]/d' -e 's/* \(.*\)/\1/'
}

repo_isnot_dirty() {
    git diff --quiet && git diff --cached --quiet
}

repo_isin() {
    git -C $(pwd) 2>/dev/null rev-parse
}

repo_string() {
    if repo_isin; then
        local branch="$(repo_branch)"
        if [ -n "$branch" ]; then
            branch=" $branch"
        fi

        local gstatus="$(git status --porcelain)"

        local nuntack=$(echo "$gstatus" | grep -E '^\?\?' | wc -l)
        if [ $nuntack -gt 0 ]; then
            nuntack=" ${nuntack}U"
        else
            nuntack=""
        fi

        if repo_isnot_dirty; then
            echo -e -n  "${echo_bold_purple}[${echo_bold_yellow}${branch}${echo_orange}${nuntack} ${echo_bold_purple}]"
        else

            local nmod=$(echo "$gstatus" | grep -E '^ M' | wc -l)
            if [ $nmod -gt 0 ]; then
                nmod=" ${nmod}M"
            else
                nmod=""
            fi

            local nmods=$(echo "$gstatus" | grep -E '^A' | wc -l)
            if [ $nmods -gt 0 ]; then
                nmods=" ${nmods}S"
            else
                nmods=""
            fi

            echo -e -n "${echo_bold_purple}[${echo_bold_red}${branch}${echo_green}${nmods}${echo_yellow}${nmod}${echo_orange}${nuntack} ${echo_bold_purple}]"
        fi
    else
        echo -n ""
    fi
}


## virtualenv
function virtualenv_info(){
    # Get Virtual Env
    if [[ -n "$VIRTUAL_ENV" ]]; then
        # Strip out the path and just leave the env name
        venv="${VIRTUAL_ENV##*/}"
    else
        # In case you don't have one activated
        venv=''
    fi
    [[ -n "$venv" ]] && echo -e -n "${echo_bold_purple}[ ${echo_bold_green}venv ${echo_green}$venv ${echo_bold_purple}]"
}


PS1="\n${bold_purple}┌─[${cyan} \w ${bold_purple}]\$(repo_string)\$(virtualenv_info)\n${bold_purple}└─▪${normal} "
